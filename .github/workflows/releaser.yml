# Release command:
#
#  gh workflow run Releaser
#
name: Releaser
permissions: write-all
on:
  workflow_dispatch:

jobs:
  releaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v2.3.4
        with:
          ssh-key: "${{ secrets.RELEASER_SSH_KEY }}"
          fetch-depth: 0

      - name: Setup Python üîß
        uses: actions/setup-python@v2.2.2
        with:
          python-version: 3.9.6

      - name: Build release notes üìù
        id: relnote
        run: |
          set -e
          set -o pipefail

          pip install reno pandoc

          git fetch --tag
          VERSION=$(reno -q semver-next)

          git tag $VERSION
          git push origin $VERSION

          echo "** RENO **"
          reno -q report --version $VERSION --title "" --no-show-source

          echo "** MARKDOWN **"
          reno -q report --version $VERSION --title "" --no-show-source |\
              pandoc -t markdown --shift-heading-level-by=-1

          echo "** FILTER **"
          reno -q report --version $VERSION --title "" --no-show-source |\
              pandoc -t markdown --shift-heading-level-by=-1 |\
              sed -e '/^\.\./,+1d' -e '1,4d'

          reno -q report --version $VERSION --title "" --no-show-source | \
              pandoc -t markdown --shift-heading-level-by=-1 | \
              sed -e '/^\.\./,+1d' -e '1,4d' > ${{ github.workspace }}-CHANGELOG.txt
          echo "::set-output name=VERSION::$VERSION"

      - name: Release üèéÔ∏è
        uses: softprops/action-gh-release@v1
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          tag_name: ${{ steps.relnote.outputs.VERSION }}
